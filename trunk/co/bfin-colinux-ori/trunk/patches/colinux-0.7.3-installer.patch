--- colinux-0.7.3/coLinux/src/src/colinux/os/winnt/user/install/colinux.nsi
+++ colinux-0.7.3/coLinux/src/src/colinux/os/winnt/user/install/colinux.nsi
@@ -37,6 +37,9 @@
   VIAddVersionKey LegalCopyright "Copyright @ 2004-2007 ${PUBLISHER}"
   VIProductVersion "${LONGVERSION}"
 
+  !define MUI_ICON "scripts\blackfin.ico"
+  SetCompressor lzma
+
   XPStyle on
 
 ; For priority Unpack
@@ -67,8 +70,10 @@
   !insertmacro MUI_PAGE_LICENSE "..\..\..\..\..\..\COPYING"
   !insertmacro MUI_PAGE_COMPONENTS
   !insertmacro MUI_PAGE_DIRECTORY
-  Page custom WinpcapRedir WinpcapRedirLeave
-  Page custom StartDlImageFunc EndDlImageFunc
+;  Page custom WinpcapRedir WinpcapRedirLeave
+;  Page custom StartDlImageFunc EndDlImageFunc
+  Page custom PageFileSystem PageFileSystemLeave
+  Page custom PageNetworking PageNetworkingLeave
   !insertmacro MUI_PAGE_INSTFILES
 
   !define MUI_FINISHPAGE_LINK "Visit the Cooperative Linux website"
@@ -265,6 +270,206 @@ SectionEnd
 
 SectionGroupEnd
 
+!include nsDialogs.nsh
+!include LogicLib.nsh
+
+Var FS_init
+Var FS_Dialog
+Var FS_RAM_Label
+Var FS_RAM_Text
+Var FS_RAM_Value
+Var FS_SWAP_Label
+Var FS_SWAP_Text
+Var FS_SWAP_Value
+Var FS_ROOT_Label
+Var FS_ROOT_Text
+Var FS_ROOT_Value
+Function PageFileSystem
+  ${If} $FS_init == ""
+    StrCpy $FS_init "yes"
+    StrCpy $FS_RAM_Value "512"
+    StrCpy $FS_SWAP_Value "768"
+    StrCpy $FS_ROOT_Value "5000"
+  ${EndIf}
+
+  Pop $R0
+
+  !insertmacro MUI_HEADER_TEXT "Setup RAM and File System options" "(setup default 'blackfin.conf')"
+  nsDialogs::Create /NOUNLOAD 1018
+  Pop $FS_Dialog
+  ${If} $FS_Dialog == error
+    Abort
+  ${EndIf}
+
+  ${NSD_CreateLabel} 0 0% 60% 24u "How much RAM should coLinux use? (in MB)$\r$\n  (recommend: min = 256, optimal = 512+)"
+  Pop $FS_RAM_Label
+  ${NSD_CreateText} 60% 2% 25% 12u $FS_RAM_Value
+  Pop $FS_RAM_Text
+
+  ${NSD_CreateLabel} 0 25% 60% 24u "How much swap should coLinux use? (in MB)    (recommend: min = RAM, optimal = 1.5xRAM)"
+  Pop $FS_SWAP_Label
+  ${NSD_CreateText} 60% 27% 25% 12u $FS_SWAP_Value
+  Pop $FS_SWAP_Text
+
+  ${NSD_CreateLabel} 0 50% 60% 24u "How big should the file system be? (in MB)    (recommend: min = 4000, optimal = 6000+)"
+  Pop $FS_ROOT_Label
+  ${NSD_CreateText} 60% 52% 25% 12u $FS_ROOT_Value
+  Pop $FS_ROOT_Text
+
+  nsDialogs::Show
+FunctionEnd
+Function PageFileSystemLeave
+  ${NSD_GetText} $FS_RAM_Text $FS_RAM_Value
+  ${NSD_GetText} $FS_SWAP_Text $FS_SWAP_Value
+  ${NSD_GetText} $FS_ROOT_Text $FS_ROOT_Value
+FunctionEnd
+
+Var NW_init
+Var NW_Dialog
+Var NW_Label
+Var NW_WinIP_Label
+Var NW_WinIP_Text
+Var NW_WinIP_Value
+Var NW_LinIP_Label
+Var NW_LinIP_Text
+Var NW_LinIP_Value
+Var NW_COM_Label
+Var NW_COM_Text
+Var NW_COM_Value
+Function PageNetworking
+  ${If} $NW_init == ""
+    StrCpy $NW_init "yes"
+    StrCpy $NW_WinIP_Value "10.12.12.1"
+    StrCpy $NW_LinIP_Value "10.12.12.2"
+    StrCpy $NW_COM_Value "COM1"
+  ${EndIf}
+
+  !insertmacro MUI_HEADER_TEXT "Setup Networking and Serial options" "(setup default 'blackfin.conf')"
+  nsDialogs::Create /NOUNLOAD 1018
+  Pop $NW_Dialog
+  ${If} $NW_Dialog == error
+    Abort
+  ${EndIf}
+
+  ${NSD_CreateLabel} 0 0% 100% 24u "Configure the network settings of the private TAP network tunnel for communication between Windows and coLinux.  The default values are fine."
+  Pop $NW_Label
+
+  ${NSD_CreateLabel} 0 20% 50% 12u "Windows IP Address"
+  Pop $NW_WinIP_Label
+  ${NSD_CreateText} 50% 20% 25% 12u $NW_WinIP_Value
+  Pop $NW_WinIP_Text
+
+  ${NSD_CreateLabel} 0 40% 50% 12u "Linux IP Address"
+  Pop $NW_LinIP_Label
+  ${NSD_CreateText} 50% 40% 25% 12u $NW_LinIP_Value
+  Pop $NW_LinIP_Text
+
+  ${NSD_CreateLabel} 0 60% 50% 12u "Serial Port Settings"
+  Pop $NW_COM_Label
+  ${NSD_CreateText} 50% 60% 25% 12u $NW_COM_Value
+  Pop $NW_COM_Text
+
+  nsDialogs::Show
+FunctionEnd
+Function PageNetworkingLeave
+  ${NSD_GetText} $NW_WinIP_Text $NW_WinIP_Value
+  ${NSD_GetText} $NW_LinIP_Text $NW_LinIP_Value
+  ${NSD_GetText} $NW_COM_Text $NW_COM_Value
+FunctionEnd
+
+Section -CreateConfigFile
+  SetOutPath -
+  IfFileExists "blackfin.conf" check_config write_config
+  check_config:
+  MessageBox MB_YESNO|MB_ICONQUESTION|MB_DEFBUTTON2 "You already have a configuration file.  Do you wish to replace it with the new default settings?$\r$\n$\r$\nExisting file: $INSTDIR\blackfin.conf" /SD IDNO IDNO skip_config
+  write_config:
+  FileOpen $0 "blackfin.conf" w
+  FileWrite $0 "# This is a default config generated by the Blackfin coLinux installer.$\r$\n"
+  FileWrite $0 "# For more information, please see these sources:$\r$\n"
+  FileWrite $0 "#   example.conf$\r$\n"
+  FileWrite $0 "#   colinux-daemon.txt$\r$\n"
+  FileWrite $0 "#   http://www.colinux.org/$\r$\n"
+  FileWrite $0 "#   http://docs.blackfin.uclinux.org/doku.php?id=colinux$\r$\n"
+  FileWrite $0 "$\r$\n"
+  FileWrite $0 "# Please do not change unless you understand these settings$\r$\n"
+  FileWrite $0 "kernel=vmlinux$\r$\n"
+  FileWrite $0 "cobd0=blackfin-rootfs.img$\r$\n"
+  FileWrite $0 "cobd1=blackfin-swap.img$\r$\n"
+  FileWrite $0 "root=/dev/cobd0$\r$\n"
+  FileWrite $0 "ro$\r$\n"
+  FileWrite $0 "initrd=initrd.gz$\r$\n"
+  FileWrite $0 "$\r$\n"
+  FileWrite $0 "# These cofs lines control what paths will be available to coLinux$\r$\n"
+  FileWrite $0 "# They take the form of: cofs#=<path>$\r$\n"
+  FileWrite $0 "cofs0=C:\$\r$\n"
+  FileWrite $0 "$\r$\n"
+  FileWrite $0 "# How much RAM will coLinux reserve for itself$\r$\n"
+  FileWrite $0 "mem=$FS_RAM_Value$\r$\n"
+  FileWrite $0 "$\r$\n"
+  FileWrite $0 "# Networking configuration (including port forwarding options)$\r$\n"
+  FileWrite $0 "# http://colinux.wikia.com/wiki/Network$\r$\n"
+  FileWrite $0 "eth0=slirp,,tcp:22:22/tcp:333:22/tcp:10000:10000/udp:69:69$\r$\n"
+  FileWrite $0 "eth1=tuntap$\r$\n"
+  FileWrite $0 "$\r$\n"
+  FileWrite $0 "# Serial configuration$\r$\n"
+  FileWrite $0 'ttys0=$NW_COM_Value,"baud=57600 parity=N data=8 stop=1 xon=off odsr=off octs=off idsr=off to=on rts=on dtr=on"$\r$\n'
+  FileClose $0
+  skip_config:
+SectionEnd
+
+Section "Shortcuts" Shortcuts
+  SetOutPath -
+  File scripts\blackfin.ico
+  CreateDirectory "$SMPROGRAMS\Analog Devices\coLinux"
+  CreateShortCut "$SMPROGRAMS\Analog Devices\coLinux\Documentation.lnk" "http://docs.blackfin.uclinux.org/doku.php?id=colinux" "" "$INSTDIR\blackfin.ico"
+  CreateShortCut "$SMPROGRAMS\Analog Devices\coLinux\Uninstall.lnk" "$INSTDIR\Uninstall.exe"
+  CreateDirectory "$SMPROGRAMS\Analog Devices\coLinux\Non-Service"
+  CreateShortCut "$SMPROGRAMS\Analog Devices\coLinux\Non-Service\coLinux.lnk" "$INSTDIR\colinux-daemon.exe" "@blackfin.conf" "" "" SW_SHOWMINIMIZED
+  CreateShortCut "$SMPROGRAMS\Analog Devices\coLinux\Non-Service\coLinux (single).lnk" "$INSTDIR\colinux-daemon.exe" "@blackfin.conf single" "" "" SW_SHOWMINIMIZED
+  CreateShortCut "$SMPROGRAMS\Analog Devices\coLinux\Non-Service\coLinux (rescue).lnk" "$INSTDIR\colinux-daemon.exe" "@blackfin.conf init=/bin/sh rw" "" "" SW_SHOWMINIMIZED
+  CreateDirectory "$SMPROGRAMS\Analog Devices\coLinux\Service"
+  CreateShortCut "$SMPROGRAMS\Analog Devices\coLinux\Service\Install.lnk" "$INSTDIR\colinux-daemon.exe" "--install-service Blackfin-coLinux @blackfin.conf"
+  CreateShortCut "$SMPROGRAMS\Analog Devices\coLinux\Service\Uninstall.lnk" "$INSTDIR\colinux-daemon.exe" "--remove-service Blackfin-coLinux"
+  CreateShortCut "$SMPROGRAMS\Analog Devices\coLinux\Service\Start.lnk" "net" "start Blackfin-coLinux"
+  CreateShortCut "$SMPROGRAMS\Analog Devices\coLinux\Service\Stop.lnk" "net" "stop Blackfin-coLinux"
+  CreateShortCut "$SMPROGRAMS\Analog Devices\coLinux\Service\Console (fltk).lnk" "$INSTDIR\colinux-console-fltk.exe" "-a 0"
+  CreateShortCut "$SMPROGRAMS\Analog Devices\coLinux\Service\Console (nt).lnk" "$INSTDIR\colinux-console-nt.exe" "-a 0"
+
+  ; we tell it to use explorer as a direct path link makes the system try
+  ; to see if the path exists in the first place
+  CreateShortCut "$SMPROGRAMS\Analog Devices\coLinux\uclinux home (Samba).lnk" "explorer" "\\$NW_LinIP_Value\uclinux"
+
+  Push $R0
+  ClearErrors
+  ReadRegStr $R0 HKLM SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\PuTTY_is1 InstallLocation
+  IfErrors 0 have_putty
+  IfFileExists "C:\Program Files\PuTTY\putty.exe" 0 have_putty
+  StrCpy $R0 "C:\Program Files\PuTTY\"
+  have_putty:
+  DetailPrint "Found PuTTY installed at $R0"
+  CreateShortCut "$SMPROGRAMS\Analog Devices\coLinux\PuTTY root@coLinux.lnk" "$R0putty.exe" "-X root@$NW_LinIP_Value"
+  CreateShortCut "$SMPROGRAMS\Analog Devices\coLinux\PuTTY uclinux@coLinux.lnk" "$R0putty.exe" "-X uclinux@$NW_LinIP_Value"
+  Pop $R0
+SectionEnd
+
+Section "Putty" Putty
+  File /oname=putty-installer.exe upstream\putty-*-installer.exe
+  ExecWait putty-installer.exe
+  Delete putty-installer.exe
+SectionEnd
+
+Section "WinPcap" WinPcap
+  File /oname=WinPcap.exe upstream\WinPcap_*.exe
+  ExecWait WinPcap.exe
+  Delete WinPcap.exe
+SectionEnd
+
+Section "XMing" XMing
+  File /oname=Xming-setup.exe upstream\Xming-*-setup.exe
+  ExecWait Xming-setup.exe
+  Delete Xming-setup.exe
+SectionEnd
+
 # Defines must sync with entries in file iDl.ini
 !define IDL_NOTHING 1
 !define IDL_ARCHLINUX 2
@@ -274,7 +479,7 @@ SectionGroupEnd
 !define IDL_UBUNTU 6
 !define IDL_LOCATION 7
 
-Section "Root Filesystem image Download" SeccoLinuxImage
+Section "-Root Filesystem image Download" SeccoLinuxImage
 
    ;----------------------------------------------------------
    ; Random sourceforge download
@@ -459,6 +664,50 @@ Section -post
 
 SectionEnd
 
+Section -post
+    ; netsh deals in "adapters".  devcon (tapcontrol) deals in "hwids".  neither
+    ; displays the other info, so there is no easy way to translate between the
+    ; two.  ipconfig however displays both "adapters" and "hwids".  so we use that
+    ; to figure out the adapter name for a specific hwid.  lame.
+    ; XXX: is there a localization issue here ?  is ipconfig always english ?
+    DetailPrint "Setting up network for coLinux TAP"
+    nsExec::ExecToLog 'cmd /C ipconfig /all > "$INSTDIR\ipconfig-list.txt"'
+    Pop $R0 # return value/error/timeout
+    Push $0 # fd
+    Push $1 # str line scratch
+    Push $2 # adapter
+    Push $3 # hwid
+    StrCpy $2 ""
+    ClearErrors
+    FileOpen $0 "$INSTDIR\ipconfig-list.txt" r
+    IfErrors ip_fail
+    ip_line:
+    FileRead $0 $R0
+    IfErrors ip_done
+    StrCpy $1 $R0 17
+    ${IF} $1 == "Ethernet adapter "
+      StrCpy $2 $R0 -2 17
+    ${ELSE}
+      StrCpy $1 $R0 44
+      ${IF} $1 == "        Description . . . . . . . . . . . : "
+        StrCpy $3 $R0 -1 44
+        ${IF} $3 == "TAP-Win32 Adapter V8 (coLinux)"
+          nsExec::ExecToLog 'netsh.exe interface ip set address "$2" static "$NW_WinIP_Value" 255.255.255.0'
+          Pop $R0 # return value/error/timeout
+          GoTo ip_done
+        ${ENDIF}
+      ${ENDIF}
+    ${ENDIF}
+    GoTo ip_line
+    ip_done:
+    FileClose $0
+    ip_fail:
+    Delete "$INSTDIR\ipconfig-list.txt"
+    Pop $2
+    Pop $1
+    Pop $0
+SectionEnd
+
 ;--------------------
 ;Post-install section
 
@@ -475,6 +724,79 @@ Section -post
     Pop $R0 # return value/error/timeout
 SectionEnd
 
+!ifndef BFIN_BASE
+Section -post
+  SetOutPath -
+
+  IfFileExists "blackfin-rootfs.img" 0 do_init
+  DetailPrint "File system image (blackfin-rootfs.img) already exists; skipping rootfs setup"
+  GoTo done_init
+  do_init:
+
+  ; Much faster to run mkFile than to use `dd` in coLinux
+  File scripts\mkFile.exe
+  DetailPrint "Creating swap file"
+  nsExec::ExecToLog 'mkFile -m blackfin-swap.img $FS_SWAP_Value'
+  Pop $R0
+  IntCmp $R0 0 swap_made
+  MessageBox MB_OK|MB_ICONSTOP "Unable to create the swap file.  Are you out of space?$\r$\n$\r$\nSwap file: $INSTDIR\blackfin-swap.img"
+  Abort
+  swap_made:
+  DetailPrint "Creating root file system file"
+  nsExec::ExecToLog 'mkFile -m blackfin-rootfs.img $FS_ROOT_Value'
+  Pop $R0
+  IntCmp $R0 0 root_made
+  MessageBox MB_OK|MB_ICONSTOP "Unable to create the rootfs file.  Are you out of space?$\r$\n$\r$\nSwap file: $INSTDIR\blackfin-rootfs.img"
+  Delete blackfin-swap.img
+  Abort
+  root_made:
+
+  DetailPrint "Passing install settings to coLinux"
+  FileOpen $0 "colinux.settings" w
+  FileWrite $0 "CL_SWAP=cobd1$\n"
+  FileWrite $0 "CL_ROOT=cobd0$\n"
+  FileWrite $0 "CL_RAM_SIZE=$FS_RAM_Value$\n"
+  FileWrite $0 "CL_SWAP_SIZE=$FS_SWAP_Value$\n"
+  FileWrite $0 "CL_ROOT_SIZE=$FS_ROOT_Value$\n"
+  FileWrite $0 "CL_WINIP=$NW_WinIP_Value$\n"
+  FileWrite $0 "CL_LINIP=$NW_LinIP_Value$\n"
+  FileWrite $0 "CL_COM=$NW_COM_Value$\n"
+  FileClose $0
+
+  File tarballs\init.tar
+  File tarballs\blackfin-configs.tar
+  File tarballs\blackfin-root.tar
+  File scripts\init.sh
+  File scripts\passwd.exp
+
+  DetailPrint "Initializing file system images (this may take a bit)"
+  nsExec::ExecToLog 'cmd /C set COLINUX_CONSOLE_EXIT_ON_DETACH=1 & \
+                     colinux-daemon.exe -k -v 1 \
+                         kernel=vmlinux \
+                         initrd=initrd.gz \
+                         cofs0=. \
+                         cobd0=blackfin-rootfs.img \
+                         cobd1=blackfin-swap.img \
+                         COLINUX_SETUP=yes \
+                         COLINUX_SETUP_FS=cofs0 \
+                         COLINUX_SETUP_EXEC=init.sh'
+  Pop $R0
+  IntCmp $R0 0 imgs_setup
+  MessageBox MB_OK|MB_ICONSTOP "Initialization of file systems failed.  Please report this."
+  Abort
+  imgs_setup:
+
+  Delete passwd.exp
+  Delete init.sh
+  Delete blackfin-root.tar
+  Delete blackfin-configs.tar
+  Delete init.tar
+
+  Delete colinux.settings
+
+  done_init:
+SectionEnd
+!endif
 
 ;--------------------------------
 ;Descriptions
@@ -488,6 +810,10 @@ SectionEnd
   LangString DESC_SeccoLinuxSerial ${LANG_ENGLISH} "Virtual Serial Driver allows to use serial Devices between Linux and Windows"
   LangString DESC_SeccoLinuxDebug ${LANG_ENGLISH} "Debugging allows to create extensive debug log for troubleshooting problems"
   LangString DESC_SecImage ${LANG_ENGLISH} "Download an image from sourceforge. Also provide useful links on how to use it"
+  LangString DESC_Shortcuts ${LANG_ENGLISH} "Standard useful start menu shortcuts.  They're useful."
+  LangString DESC_Putty ${LANG_ENGLISH} "Free implementation of Telnet and SSH to work with coLinux."
+  LangString DESC_WinPcap ${LANG_ENGLISH} "Allow coLinux to access the network."
+  LangString DESC_XMing ${LANG_ENGLISH} "Display graphical programs under coLinux in your Windows environment."
 
   !insertmacro MUI_FUNCTION_DESCRIPTION_BEGIN
     !insertmacro MUI_DESCRIPTION_TEXT ${SecGrpcoLinux} $(DESC_SecGrpcoLinux)
@@ -498,7 +824,11 @@ SectionEnd
     !insertmacro MUI_DESCRIPTION_TEXT ${SeccoLinuxBridgedNet} $(DESC_SeccoLinuxBridgedNet)
     !insertmacro MUI_DESCRIPTION_TEXT ${SeccoLinuxSerial} $(DESC_SeccoLinuxSerial)
     !insertmacro MUI_DESCRIPTION_TEXT ${SeccoLinuxDebug} $(DESC_SeccoLinuxDebug)
-    !insertmacro MUI_DESCRIPTION_TEXT ${SeccoLinuxImage} $(DESC_SecImage)  
+    !insertmacro MUI_DESCRIPTION_TEXT ${SeccoLinuxImage} $(DESC_SecImage)
+    !insertmacro MUI_DESCRIPTION_TEXT ${Shortcuts} $(DESC_Shortcuts)
+    !insertmacro MUI_DESCRIPTION_TEXT ${Putty} $(DESC_Putty)
+    !insertmacro MUI_DESCRIPTION_TEXT ${WinPcap} $(DESC_WinPcap)
+    !insertmacro MUI_DESCRIPTION_TEXT ${XMing} $(DESC_XMing)
   !insertmacro MUI_FUNCTION_DESCRIPTION_END
 
 ;--------------------------------
@@ -541,7 +871,16 @@ Section "Uninstall"
   Delete "$INSTDIR\netdriver\tap0801co.sys"
   Delete "$INSTDIR\netdriver\tapcontrol.exe"
   Delete "$INSTDIR\netdriver\tap.cat"
-  
+
+  Delete "$INSTDIR\mkFile.exe"
+  Delete "$INSTDIR\blackfin.ico"
+  RMDir /r "$SMPROGRAMS\Analog Devices\coLinux"
+  MessageBox MB_YESNO|MB_ICONQUESTION|MB_DEFBUTTON2 \
+    "Do you wish to delete your file system images and configuration files as well?" \
+    /SD IDNO IDNO no_delete
+  RMDir /r "$INSTDIR"
+  no_delete:
+
   ;--------------------------------------------------------------/FILES--
   ;----------------------------------------------------------------------
 
